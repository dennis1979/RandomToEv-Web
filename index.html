<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>動態權重隨機抽樣</title>
  <style>
    body { font-family: monospace; }
    .result { white-space: pre; }
    button { margin: 8px 0; }
  </style>
</head>
<body>
  <h2>動態權重隨機抽樣</h2>
  <label for="totalInput">取樣數量：</label>
  <input type="number" id="totalInput" value="1000" min="1" max="10000" style="margin: 8px;">
  <br>
  <label for="displayInput">顯示前幾筆：</label>
  <input type="number" id="displayInput" value="20" min="1" max="100" style="margin: 8px;">
  <button onclick="runSampling()">重新執行</button>
  <div class="result" id="output"></div>
  <script>
    function runSampling() {
      const m = [0, 0.3, 0.5, 0.8, 1, 1.2, 2, 3, 10, 20, 50, 100, 200];
      const total = parseInt(document.getElementById('totalInput').value) || 1000;
      const displayCount = parseInt(document.getElementById('displayInput').value) || 20;
      const expectValue = 0.9;

      // 計算權重
      let nonzeroWeights = m.map(n => n !== 0 ? 1 / n : 0).filter(w => w > 0);
      let sumNonzero = nonzeroWeights.reduce((a, b) => a + b, 0);
      let weights = m.map(n => n === 0 ? sumNonzero : 1 / n);

      function normalize(arr) {
        const s = arr.reduce((a, b) => a + b, 0);
        return arr.map(x => x / s);
      }

      function weightedRandomChoice(arr, weights) {
        let r = Math.random();
        let acc = 0;
        for (let i = 0; i < arr.length; i++) {
          acc += weights[i];
          if (r < acc) return arr[i];
        }
        return arr[arr.length - 1];
      }

      // 動態抽樣
      let result2 = [];
      for (let i = 0; i < total; i++) {
        if (i === 0) {
          result2.push(weightedRandomChoice(m, normalize(weights)));
        } else {
          const currentAvg = result2.reduce((a, b) => a + b, 0) / result2.length;
          let adjustedWeights = m.map((n, idx) => {
            if (currentAvg < expectValue) {
              return n < expectValue ? weights[idx] * 0.3 : weights[idx] * 1;
            } else {
              return n < expectValue ? weights[idx] * 1.2 : weights[idx] * 0.3;
            }
          });
          adjustedWeights = normalize(adjustedWeights);
          result2.push(weightedRandomChoice(m, adjustedWeights));
        }
      }

      const avg = result2.reduce((a, b) => a + b, 0) / result2.length;
      const firstNAvg = result2.slice(0, displayCount).reduce((a, b) => a + b, 0) / Math.min(displayCount, result2.length);

      // 顯示結果
      let output = '';
      output += '倍數種類 = 0, 0.8, 1, 1.2, 10, 20, 50, 100, 200 \n';
      output += `取樣${total}筆, 目標期望值0.9, 數列平均值：` + avg + '\n';
      output += `前${displayCount}筆的平均值：` + firstNAvg + '\n';
      output += `前${displayCount}筆資料：\n` + result2.slice(0, displayCount).join('\n');
      document.getElementById('output').textContent = output;
    }

    // 頁面載入時先執行一次
    runSampling();
  </script>
</body>
</html>
